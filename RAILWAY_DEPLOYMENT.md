# 🚂 Railway Deployment Guide for قانونيد Legal AI Agent

## 📋 Project Overview

This is a **Saudi Legal AI Agent** that combines:
- **FastAPI Backend**: CrewAI-powered chatbot and roadmap agents
- **HTML Frontend**: Modern Arabic UI for legal consultations
- **Streamlit App**: Virtual ruling system
- **Vector Database**: FAISS-based legal knowledge base

## 🏗️ Architecture

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   HTML Frontend │    │  Streamlit App  │    │  FastAPI Backend│
│   (Static)      │    │  (Virtual       │    │  (CrewAI +      │
│                 │    │   Ruling)       │    │   OpenAI)       │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         └───────────────────────┼───────────────────────┘
                                 │
                    ┌─────────────────┐
                    │ Railway Volume  │
                    │ (Persistent     │
                    │  Data Storage)  │
                    └─────────────────┘
```

## 📊 Data Requirements

### Source Data (Small - Can be in Git)
- `data/cases.jsonl` (1.2MB) - Legal cases for virtual ruling
- `data/laws_index.json` (12MB) - Legal articles and amendments
- `data/legal_sources.txt` (56KB) - Legal source references

### Generated Data (Large - Railway Volume)
- `data/law_vector_store/` - FAISS vector embeddings (several GB)
- Generated by `embeddings/build_faiss.py` during deployment

## 🚀 Railway Deployment Steps

### 1. Prerequisites
- [Railway Account](https://railway.app)
- [GitHub Repository](https://github.com) with your code
- OpenAI API Key

### 2. Connect Repository
1. Go to [Railway Dashboard](https://railway.app/dashboard)
2. Click "New Project"
3. Select "Deploy from GitHub repo"
4. Choose your repository

### 3. Configure Environment Variables
Set these in Railway project settings:

```bash
OPENAI_API_KEY=your_openai_api_key_here
VECTOR_STORE_PATH=/app/data/law_vector_store
CORS_ORIGINS=*
```

### 4. Create Railway Volume
1. In your Railway project, go to "Volumes" tab
2. Click "New Volume"
3. Name: `legal-data`
4. Mount Path: `/app/data`
5. Size: At least 5GB (recommended 10GB)

### 5. Deploy
1. Railway will automatically detect the Dockerfile
2. Build will start automatically
3. First deployment will take longer due to vector store generation

## 🔧 Deployment Process

### Build Phase
1. **Install Dependencies**: Python packages from `Requirements.txt`
2. **Copy Code**: Application source code
3. **Setup Data Directory**: Create `/app/data` for volume mounting

### Runtime Phase
1. **Check Data**: Verify volume mount and existing data
2. **Generate Vector Store**: Run `embeddings/build_faiss.py` if needed
3. **Start Server**: Launch FastAPI server on Railway's PORT

## 📁 File Structure After Deployment

```
/app/
├── backend/           # FastAPI application
├── embeddings/        # Vector store generation scripts
├── data/             # Railway Volume Mount
│   ├── cases.jsonl
│   ├── laws_index.json
│   ├── legal_sources.txt
│   └── law_vector_store/  # Generated during deployment
├── Style/            # HTML frontend
├── pages/            # Streamlit pages
└── scrapers/         # Data scraping utilities
```

## 🚨 Important Notes

### Data Persistence
- **Vector Store**: Stored in Railway Volume (persists between deployments)
- **Source Data**: Also in Volume for consistency
- **Regeneration**: Vector store rebuilds automatically if missing

### API Endpoints
- **Health Check**: `GET /health`
- **Chat**: `POST /api/chat`
- **Roadmap**: `POST /api/roadmap`
- **Streaming**: `GET /api/chat/stream`

### Performance
- **First Run**: Slow due to vector store generation
- **Subsequent Runs**: Fast startup with existing data
- **Memory**: Ensure Railway plan has sufficient RAM (2GB+ recommended)

## 🔍 Troubleshooting

### Common Issues

1. **Vector Store Generation Fails**
   - Check OpenAI API key
   - Verify volume mount permissions
   - Check Railway logs for errors

2. **Port Binding Issues**
   - Railway sets PORT environment variable
   - Application binds to 0.0.0.0:$PORT

3. **Data Not Persisting**
   - Verify volume mount path
   - Check volume size and permissions

### Logs
- Check Railway deployment logs
- Monitor startup script output
- Verify data directory contents

## 📈 Scaling Considerations

- **Horizontal Scaling**: Multiple instances can share the same volume
- **Vertical Scaling**: Increase Railway plan for more CPU/RAM
- **Data Growth**: Monitor volume usage and increase size as needed

## 🎯 Next Steps

1. **Deploy to Railway** following the steps above
2. **Monitor First Deployment** for vector store generation
3. **Test All Endpoints** to ensure functionality
4. **Configure Custom Domain** if needed
5. **Set Up Monitoring** for production use

## 📞 Support

If you encounter issues:
1. Check Railway deployment logs
2. Verify environment variables
3. Ensure volume is properly mounted
4. Check OpenAI API key validity

---

**Happy Deploying! 🚀**
